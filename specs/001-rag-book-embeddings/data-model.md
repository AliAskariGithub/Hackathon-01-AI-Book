# Data Model: RAG Pipeline for Book Content Embeddings

**Feature**: 001-rag-book-embeddings
**Date**: 2025-12-28

## Overview

This document defines the data entities used in the RAG pipeline. Since this is a vector-based system without a relational database, entities are represented as Python dataclasses and Qdrant payload schemas.

## Entities

### 1. ContentPage

Represents a scraped page from the Docusaurus book.

```python
@dataclass
class ContentPage:
    url: str              # Full URL of the page
    title: str            # Page title extracted from <title> or <h1>
    raw_content: str      # Full text content after HTML extraction
    scraped_at: datetime  # Timestamp when page was scraped
```

**Source**: Extracted from HTML via BeautifulSoup
**Lifecycle**: Created during scraping, used to generate chunks, not persisted

---

### 2. ContentChunk

Represents a chunked segment of page content.

```python
@dataclass
class ContentChunk:
    id: str               # Unique identifier (UUID)
    content_hash: str     # SHA-256 hash of chunk text (for deduplication)
    text: str             # The actual chunk text content
    token_count: int      # Number of tokens (via Cohere tokenizer)
    chunk_index: int      # Position within the parent page (0-indexed)
    page_url: str         # Reference to parent page URL
    page_title: str       # Copied from parent page for retrieval display
```

**Validation Rules**:
- `token_count` must be between 500-1000 (soft limit, may be smaller for end-of-page)
- `content_hash` must be unique within collection (FR-014)
- `chunk_index` starts at 0 for each page

**State Transitions**:
```
Created → Embedded → Stored
         ↓
    [Rate Limited] → Retry → Embedded
```

---

### 3. VectorEmbedding

Represents the numerical vector generated by Cohere API.

```python
@dataclass
class VectorEmbedding:
    chunk_id: str         # Reference to ContentChunk.id
    vector: List[float]   # 1024-dimensional embedding vector
    model: str            # "embed-english-v3.0"
    input_type: str       # "search_document" or "search_query"
    created_at: datetime  # Timestamp when embedding was generated
```

**Constraints**:
- `vector` length must be exactly 1024
- `model` must match collection configuration

---

### 4. QdrantPayload (Stored with Vector)

The metadata stored alongside each vector in Qdrant.

```python
# Qdrant payload schema
{
    "id": str,            # UUID - unique vector identifier
    "url": str,           # Page URL (indexed for deduplication queries)
    "title": str,         # Page title
    "text": str,          # Full chunk text (for retrieval display)
    "chunk_index": int,   # Position within page
    "content_hash": str,  # SHA-256 hash (for duplicate detection)
    "token_count": int,   # Token count for reference
    "created_at": str     # ISO timestamp
}
```

**Payload Indexes** (for query performance):
- `url`: KEYWORD index (exact match for deduplication)
- `content_hash`: KEYWORD index (duplicate detection)

---

### 5. RetrievalResult

Represents a query result returned from semantic search.

```python
@dataclass
class RetrievalResult:
    chunk_id: str         # Vector ID from Qdrant
    text: str             # Chunk content
    score: float          # Cosine similarity score (0.0 to 1.0)
    url: str              # Source page URL
    title: str            # Source page title
    chunk_index: int      # Position within source page
```

**Ordering**: Results sorted by `score` descending

---

### 6. ValidationReport

Represents the outcome of pipeline validation.

```python
@dataclass
class ValidationReport:
    timestamp: datetime           # When validation ran
    total_queries: int            # Number of test queries executed
    passed_queries: int           # Queries with score > threshold
    failed_queries: int           # Queries below threshold
    pass_rate: float              # passed_queries / total_queries
    threshold: float              # Similarity threshold used (default 0.7)
    avg_similarity: float         # Average similarity across all results
    results: List[QueryResult]    # Detailed per-query results

@dataclass
class QueryResult:
    query: str                    # Test query text
    top_score: float              # Highest similarity score
    passed: bool                  # top_score > threshold
    top_results: List[RetrievalResult]  # Top-k results for inspection
```

---

## Qdrant Collection Schema

```python
from qdrant_client.models import VectorParams, Distance

collection_config = {
    "collection_name": "book_embeddings",
    "vectors_config": VectorParams(
        size=1024,                # Cohere embed-english-v3.0
        distance=Distance.COSINE  # Cosine similarity
    )
}
```

## Entity Relationships

```
ContentPage (1) ─────────────────▶ (*) ContentChunk
                  generates

ContentChunk (1) ────────────────▶ (1) VectorEmbedding
                  embedded to

VectorEmbedding + QdrantPayload ──▶ Qdrant Vector Store
                  stored in

Query ───────────────────────────▶ (*) RetrievalResult
        produces

RetrievalResult (*) ─────────────▶ (1) ContentChunk
                  references

ValidationReport (1) ────────────▶ (*) QueryResult
                  contains
```

## Data Flow

```
1. Scraping:    URL → ContentPage
2. Chunking:    ContentPage → [ContentChunk, ...]
3. Embedding:   ContentChunk → VectorEmbedding
4. Storage:     VectorEmbedding + QdrantPayload → Qdrant
5. Retrieval:   Query → VectorEmbedding → Qdrant → [RetrievalResult, ...]
6. Validation:  [Query, ...] → [QueryResult, ...] → ValidationReport
```
